<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thế Giới QR - Tạo Mã QR Động</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; min-height: 100vh; }
        .auth-container { max-width: 400px; margin: 80px auto; text-align: center; }
        .dashboard-container { max-width: 1200px; margin: 30px auto; display: none; padding: 0 15px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .google-btn { background: white; color: #333; border: 1px solid #ddd; padding: 12px; border-radius: 50px; width: 100%; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; }
        .google-btn:hover { background: #f8f9fa; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
        .vip-badge { background-color: #FFD700; color: #333; padding: 5px 12px; border-radius: 20px; font-weight: bold; }
        .qr-thumb { width: 60px; height: 60px; object-fit: contain; border: 1px solid #ddd; border-radius: 4px; }
        .quota-box { background: #e9ecef; padding: 12px; border-radius: 8px; font-size: 0.9rem; margin-bottom: 15px; }
        .quota-warning { color: #dc3545; font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="redirect-screen" style="display:none; height:100vh; background:#fff; align-items:center; justify-content:center; flex-direction:column;">
    <div class="spinner-border text-primary mb-3"></div>
    <h4>Đang kết nối...</h4>
</div>

<div id="auth-screen" class="container auth-container">
    <div class="card p-5">
        <h2 class="fw-bold text-primary mb-3"><i class="fa-solid fa-qrcode"></i> Thế Giới QR</h2>
        <p class="text-muted mb-4">Nền tảng quản lý mã QR chuyên nghiệp</p>
        
        <button onclick="loginGoogle()" class="google-btn">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="24">
            Đăng nhập bằng Google
        </button>
        <p class="text-muted mt-3 small">Không cần nhớ mật khẩu. Nhanh chóng & Bảo mật.</p>
    </div>
</div>

<div id="dashboard-screen" class="dashboard-container">
    <div class="card bg-white p-3 mb-4">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div>
                <h5 class="mb-1" id="welcomeMsg">Xin chào</h5>
                <div id="planInfo" class="small">Checking...</div>
            </div>
            <div class="text-end">
                <button class="btn btn-outline-warning text-dark fw-bold btn-sm" onclick="openPaymentModal()"><i class="fa-solid fa-crown text-warning"></i> Nâng VIP</button>
                <button class="btn btn-light btn-sm ms-2 border" onclick="logout()">Thoát</button>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white fw-bold">Tạo Mã Mới</div>
                <div class="card-body">
                    <div class="quota-box">
                        <div class="d-flex justify-content-between"><span>Kho lưu trữ:</span><span id="storageQuota">...</span></div>
                        <div class="d-flex justify-content-between mt-1"><span>Lượt tạo hôm nay:</span><span id="dailyQuota">...</span></div>
                    </div>
                    <form id="createQrForm">
                        <div class="mb-3"><label>Tên gợi nhớ</label><input type="text" class="form-control" id="qrName" required></div>
                        <div class="mb-3"><label>Link đích</label><input type="url" class="form-control" id="qrDest" placeholder="https://..." required></div>
                        <button type="submit" class="btn btn-primary w-100" id="btnCreate">Tạo QR Ngay</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header bg-white fw-bold border-bottom">Danh sách QR</div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light"><tr><th>QR</th><th>Thông tin</th><th class="text-center">View</th><th></th></tr></thead>
                            <tbody id="qrTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, orderBy, serverTimestamp, updateDoc, increment, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- CẤU HÌNH MỚI (thegioiqr-2026) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCjZfDgE4JFRilXh5dCtrTFLA3-BlerRNE",
      authDomain: "thegioiqr-2026.firebaseapp.com",
      projectId: "thegioiqr-2026",
      storageBucket: "thegioiqr-2026.firebasestorage.app",
      messagingSenderId: "911702916265",
      appId: "1:911702916265:web:d42d948ebb7e7a53dcbdb8",
      measurementId: "G-Q19JD7SBGG"
    };

    const BANK_BIN = "970422"; // Mã Ngân hàng (MB)
    const BANK_ACC = "0987654321"; // STK của bạn

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const LIMITS = { STORAGE: 3, DAILY: 3 };
    let currentUser, userProfile, myStorageCount = 0, myDailyUsage = 0;

    // --- LOGIC AUTH GOOGLE ---
    window.loginGoogle = async () => {
        try {
            const result = await signInWithPopup(auth, provider);
            // Kiểm tra user mới
            const userRef = doc(db, "users", result.user.uid);
            const snap = await getDoc(userRef);
            if (!snap.exists()) {
                await setDoc(userRef, {
                    email: result.user.email,
                    isPremium: false,
                    dailyCount: 0,
                    lastActionDate: new Date().toISOString().split('T')[0],
                    createdAt: serverTimestamp()
                });
            }
        } catch (error) {
            Swal.fire('Lỗi đăng nhập', error.message, 'error');
        }
    };

    // --- LOGIC CHUNG ---
    const scanId = new URLSearchParams(window.location.search).get('id');
    if (scanId) {
        // Mode Redirect
        document.getElementById('auth-screen').remove(); document.getElementById('dashboard-screen').remove();
        document.getElementById('redirect-screen').style.display = 'flex';
        (async () => {
            const q = query(collection(db, "qr_codes_v2"), where("shortId", "==", scanId));
            const snap = await getDocs(q);
            if (!snap.empty) {
                updateDoc(snap.docs[0].ref, { views: increment(1) });
                window.location.href = snap.docs[0].data().destination;
            } else { alert("Mã QR không tồn tại!"); }
        })();
    } else {
        // Mode Dashboard
        onAuthStateChanged(auth, async (u) => {
            if (u) {
                currentUser = u;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('dashboard-screen').style.display = 'block';
                await loadData();
            } else {
                document.getElementById('auth-screen').style.display = 'block';
                document.getElementById('dashboard-screen').style.display = 'none';
            }
        });

        async function loadData() { await loadUserProfile(); await loadMyQRs(); updateUI(); }
        async function loadUserProfile() {
            const ref = doc(db, "users", currentUser.uid); const snap = await getDoc(ref);
            const today = new Date().toISOString().split('T')[0];
            if (snap.exists()) {
                userProfile = snap.data();
                if (userProfile.lastActionDate !== today) { await updateDoc(ref, { dailyCount: 0, lastActionDate: today }); myDailyUsage = 0; }
                else { myDailyUsage = userProfile.dailyCount || 0; }
            } else {
                 userProfile = { isPremium: false, dailyCount: 0, lastActionDate: today, email: currentUser.email };
                 await setDoc(ref, userProfile);
            }
        }
        async function loadMyQRs() {
            const q = query(collection(db, "qr_codes_v2"), where("uid", "==", currentUser.uid), orderBy("createdAt", "desc"));
            const snap = await getDocs(q); myStorageCount = snap.size;
            const tbody = document.getElementById('qrTableBody'); tbody.innerHTML = '';
            snap.forEach(d => {
                const data = d.data();
                tbody.innerHTML += `<tr><td><img src="${data.imageUrl}" class="qr-thumb" onclick="viewQR('${data.imageUrl}')"></td><td><strong>${data.name}</strong><br><a href="${data.destination}" target="_blank" class="text-muted small text-decoration-none">${data.destination.substring(0,20)}...</a></td><td class="text-center fw-bold">${data.views||0}</td><td class="text-end"><button class="btn btn-sm btn-outline-danger" onclick="delQr('${d.id}')"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            });
        }
        function updateUI() {
            document.getElementById('welcomeMsg').innerText = `Xin chào, ${currentUser.displayName || currentUser.email}`;
            const planInfo = document.getElementById('planInfo'); const btn = document.getElementById('btnCreate');
            const stEl = document.getElementById('storageQuota'); const daEl = document.getElementById('dailyQuota');
            let isVip = userProfile.isPremium && userProfile.expiryDate && userProfile.expiryDate.toDate() > new Date();
            if(isVip) {
                const days = Math.ceil((userProfile.expiryDate.toDate() - new Date())/86400000);
                planInfo.innerHTML = `<span class="vip-badge"><i class="fa-solid fa-crown"></i> VIP (${days} ngày)</span>`;
                stEl.innerText = "∞"; daEl.innerText = "∞"; btn.disabled = false;
            } else {
                planInfo.innerHTML = `<span class="badge bg-secondary">Free Plan</span>`;
                stEl.innerHTML = `<span class="${myStorageCount>=LIMITS.STORAGE?'quota-warning':'quota-active'}">${myStorageCount}/${LIMITS.STORAGE}</span>`;
                daEl.innerHTML = `<span class="${myDailyUsage>=LIMITS.DAILY?'quota-warning':'quota-active'}">${myDailyUsage}/${LIMITS.DAILY}</span>`;
                btn.disabled = (myStorageCount >= LIMITS.STORAGE || myDailyUsage >= LIMITS.DAILY);
                if(btn.disabled) btn.innerText = "Đạt giới hạn"; else btn.innerText = "Tạo QR Ngay";
            }
        }
        document.getElementById('createQrForm').addEventListener('submit', async (e) => {
            e.preventDefault(); const btn = document.getElementById('btnCreate'); btn.disabled = true;
            try {
                const name = document.getElementById('qrName').value; const dest = document.getElementById('qrDest').value;
                const shortId = Math.random().toString(36).substring(2, 8);
                const link = `${window.location.href.split('?')[0]}?id=${shortId}`;
                const qr = new QRious({ value: link, size: 250 });
                await addDoc(collection(db, "qr_codes_v2"), { uid: currentUser.uid, shortId, name, destination: dest, imageUrl: qr.toDataURL(), views: 0, createdAt: serverTimestamp() });
                if(!userProfile.isPremium) await updateDoc(doc(db,"users",currentUser.uid), { dailyCount: increment(1), lastActionDate: new Date().toISOString().split('T')[0] });
                document.getElementById('createQrForm').reset(); Swal.fire('Thành công','','success'); await loadData();
            } catch (err) { Swal.fire('Lỗi', err.message, 'error'); btn.disabled = false; }
        });
        window.openPaymentModal = () => {
            const content = `TAQR ${currentUser.uid}`;
            const url = `https://img.vietqr.io/image/${BANK_BIN}-${BANK_ACC}-compact.png?amount=50000&addInfo=${encodeURIComponent(content)}`;
            Swal.fire({ title: 'Nâng cấp VIP', html: `<img src="${url}" style="width:200px;border-radius:8px"><div class="mt-2 alert alert-info">ND: <b class="text-danger">${content}</b></div>`, confirmButtonText: 'Đã chuyển' });
        };
        window.viewQR = (url) => Swal.fire({ imageUrl: url, showConfirmButton: false, showCloseButton: true });
        window.delQr = async (id) => { if(confirm("Xóa?")) { await deleteDoc(doc(db,"qr_codes_v2",id)); await loadData(); } };
        window.logout = () => signOut(auth);
    }
</script>
</body>
</html>
