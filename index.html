<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thế Giới QR - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }

        /* --- SIDEBAR STYLE --- */
        .sidebar {
            min-height: 100vh;
            background: #212529;
            color: white;
            transition: all 0.3s;
        }
        .sidebar-brand {
            padding: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            border-bottom: 1px solid #343a40;
            color: #0d6efd;
        }
        .nav-item { margin-bottom: 5px; }
        .nav-link {
            color: rgba(255,255,255,0.75);
            padding: 12px 20px;
            border-radius: 0;
            cursor: pointer;
        }
        .nav-link:hover, .nav-link.active {
            color: white;
            background: #0d6efd;
        }
        .nav-link i { width: 25px; text-align: center; margin-right: 10px; }

        /* --- MAIN CONTENT --- */
        .main-content { padding: 20px; width: 100%; }
        .card { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .vip-badge { background: #ffc107; color: #000; font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; font-weight: bold; margin-left: 5px; }
        
        /* AUTH SCREEN */
        #auth-screen { height: 100vh; display: flex; align-items: center; justify-content: center; background: #e9ecef; }
        .login-box { background: white; padding: 40px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        .google-btn { background: white; border: 1px solid #ddd; color: #333; padding: 10px 20px; border-radius: 50px; font-weight: 600; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; }
        .google-btn:hover { background: #f8f9fa; border-color: #ccc; }

        /* UTILS */
        .hidden { display: none !important; }
        .qr-thumb { width: 50px; height: 50px; object-fit: contain; border: 1px solid #eee; }
        
        /* Mobile Toggle */
        @media (max-width: 768px) {
            .sidebar { min-height: auto; }
            .sidebar-brand { text-align: center; }
        }
    </style>
</head>
<body>

<div id="redirect-screen" class="hidden" style="height:100vh; background:#fff; align-items:center; justify-content:center; flex-direction:column;">
    <div class="spinner-border text-primary mb-3"></div>
    <h4>Đang chuyển hướng...</h4>
</div>

<div id="auth-screen">
    <div class="login-box">
        <h2 class="fw-bold text-primary mb-3"><i class="fa-solid fa-qrcode"></i> Thế Giới QR</h2>
        <p class="text-muted mb-4">Hệ thống quản lý mã QR chuyên nghiệp</p>
        
        <button onclick="loginGoogle()" class="google-btn">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="24">
            Đăng nhập bằng Google
        </button>
    </div>
</div>

<div id="dashboard-screen" class="d-flex flex-column flex-md-row hidden">
    
    <nav class="sidebar col-md-3 col-lg-2 d-md-block collapse show">
        <div class="sidebar-brand">
            <i class="fa-solid fa-qrcode me-2"></i>THEGIOIQR
        </div>
        <div class="pt-3">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" onclick="switchTab('create')">
                        <i class="fa-solid fa-plus-circle"></i> Tạo Mã Mới
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="switchTab('list')">
                        <i class="fa-solid fa-list"></i> Danh Sách QR
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-warning" onclick="openPaymentModal()">
                        <i class="fa-solid fa-crown"></i> Nâng Cấp VIP
                    </a>
                </li>
                <li class="nav-item mt-4 border-top border-secondary pt-3">
                    <a class="nav-link text-danger" onclick="logout()">
                        <i class="fa-solid fa-right-from-bracket"></i> Đăng Xuất
                    </a>
                </li>
            </ul>
        </div>
        <div class="mt-auto p-3 text-white-50 small" id="userEmailDisplay">
            user@gmail.com
        </div>
    </nav>

    <main class="main-content col-md-9 ms-sm-auto col-lg-10">
        
        <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
            <h4 class="m-0" id="pageTitle">Tạo Mã QR Mới</h4>
            <div id="planInfo"><span class="badge bg-secondary">Free Plan</span></div>
        </div>

        <div id="tab-create">
            <div class="row">
                <div class="col-lg-6">
                    <div class="card p-4">
                        <div class="alert alert-light border d-flex justify-content-between align-items-center">
                            <span><i class="fa-solid fa-database me-2"></i>Kho lưu trữ:</span>
                            <span id="storageQuota" class="fw-bold">...</span>
                        </div>
                        <div class="alert alert-light border d-flex justify-content-between align-items-center mb-4">
                            <span><i class="fa-solid fa-clock me-2"></i>Lượt hôm nay:</span>
                            <span id="dailyQuota" class="fw-bold">...</span>
                        </div>

                        <form id="createQrForm">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Tên gợi nhớ</label>
                                <input type="text" class="form-control" id="qrName" placeholder="VD: Menu quán" required>
                            </div>
                            <div class="mb-4">
                                <label class="form-label fw-bold">Link đích (URL)</label>
                                <input type="url" class="form-control" id="qrDest" placeholder="https://facebook.com/..." required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 py-2 fw-bold" id="btnCreate">
                                <i class="fa-solid fa-magic me-2"></i>TẠO MÃ QR NGAY
                            </button>
                        </form>
                    </div>
                </div>
                <div class="col-lg-6 d-flex align-items-center justify-content-center text-muted">
                    <div class="text-center">
                        <i class="fa-solid fa-wand-magic-sparkles fa-3x mb-3 text-secondary"></i>
                        <p>Nhập thông tin bên trái để tạo mã QR động.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-list" class="hidden">
            <div class="card p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="80" class="text-center">QR</th>
                                <th>Tên & Link</th>
                                <th class="text-center" width="100">Lượt xem</th>
                                <th class="text-end" width="100">Xóa</th>
                            </tr>
                        </thead>
                        <tbody id="qrTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, orderBy, serverTimestamp, updateDoc, increment, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- CẤU HÌNH THEGIOIQR-2026 ---
    const firebaseConfig = {
      apiKey: "AIzaSyCjZfDgE4JFRilXh5dCtrTFLA3-BlerRNE",
      authDomain: "thegioiqr-2026.firebaseapp.com",
      projectId: "thegioiqr-2026",
      storageBucket: "thegioiqr-2026.firebasestorage.app",
      messagingSenderId: "911702916265",
      appId: "1:911702916265:web:d42d948ebb7e7a53dcbdb8",
      measurementId: "G-Q19JD7SBGG"
    };

    const BANK_BIN = "970422"; 
    const BANK_ACC = "0987654321";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const LIMITS = { STORAGE: 3, DAILY: 3 };
    let currentUser, userProfile, myStorageCount = 0, myDailyUsage = 0;

    // --- NAVIGATION LOGIC ---
    window.switchTab = (tabName) => {
        document.getElementById('tab-create').classList.add('hidden');
        document.getElementById('tab-list').classList.add('hidden');
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));

        if(tabName === 'create') {
            document.getElementById('tab-create').classList.remove('hidden');
            document.getElementById('pageTitle').innerText = "Tạo Mã QR Mới";
            document.querySelector('.nav-link[onclick="switchTab(\'create\')"]').classList.add('active');
        } else {
            document.getElementById('tab-list').classList.remove('hidden');
            document.getElementById('pageTitle').innerText = "Danh Sách Của Tôi";
            document.querySelector('.nav-link[onclick="switchTab(\'list\')"]').classList.add('active');
            loadMyQRs(); // Reload list
        }
    }

    // --- AUTH ---
    window.loginGoogle = async () => {
        try {
            const result = await signInWithPopup(auth, provider);
            const userRef = doc(db, "users", result.user.uid);
            const snap = await getDoc(userRef);
            if (!snap.exists()) {
                await setDoc(userRef, {
                    email: result.user.email,
                    isPremium: false,
                    dailyCount: 0,
                    lastActionDate: new Date().toISOString().split('T')[0],
                    createdAt: serverTimestamp()
                });
            }
        } catch (error) { Swal.fire('Lỗi', error.message, 'error'); }
    };

    // --- MAIN LOGIC ---
    const scanId = new URLSearchParams(window.location.search).get('id');
    
    if (scanId) {
        // Redirect Mode
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('redirect-screen').classList.remove('hidden');
        document.getElementById('redirect-screen').style.display = 'flex';
        
        (async () => {
            const q = query(collection(db, "qr_codes_v2"), where("shortId", "==", scanId));
            const snap = await getDocs(q);
            if (!snap.empty) {
                updateDoc(snap.docs[0].ref, { views: increment(1) });
                window.location.href = snap.docs[0].data().destination;
            } else { alert("Mã QR không tồn tại!"); }
        })();
    } else {
        // Dashboard Mode
        onAuthStateChanged(auth, async (u) => {
            if (u) {
                currentUser = u;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('dashboard-screen').classList.remove('hidden');
                document.getElementById('userEmailDisplay').innerText = u.email;
                await loadData();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('dashboard-screen').classList.add('hidden');
            }
        });

        async function loadData() { await loadUserProfile(); await loadMyQRs(); updateUI(); }

        async function loadUserProfile() {
            const ref = doc(db, "users", currentUser.uid); const snap = await getDoc(ref);
            const today = new Date().toISOString().split('T')[0];
            if (snap.exists()) {
                userProfile = snap.data();
                if (userProfile.lastActionDate !== today) { await updateDoc(ref, { dailyCount: 0, lastActionDate: today }); myDailyUsage = 0; }
                else { myDailyUsage = userProfile.dailyCount || 0; }
            } else {
                 userProfile = { isPremium: false, dailyCount: 0, lastActionDate: today, email: currentUser.email };
                 await setDoc(ref, userProfile);
            }
        }

        async function loadMyQRs() {
            const q = query(collection(db, "qr_codes_v2"), where("uid", "==", currentUser.uid), orderBy("createdAt", "desc"));
            const snap = await getDocs(q); myStorageCount = snap.size;
            const tbody = document.getElementById('qrTableBody'); tbody.innerHTML = '';
            
            if(snap.empty) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">Chưa có mã QR nào.</td></tr>';
                return;
            }

            snap.forEach(d => {
                const data = d.data();
                tbody.innerHTML += `
                    <tr>
                        <td class="text-center"><img src="${data.imageUrl}" class="qr-thumb" onclick="viewQR('${data.imageUrl}')"></td>
                        <td>
                            <strong>${data.name}</strong><br>
                            <a href="${data.destination}" target="_blank" class="text-muted small text-decoration-none">${data.destination.substring(0,30)}...</a>
                        </td>
                        <td class="text-center fw-bold text-primary">${data.views||0}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-danger" onclick="delQr('${d.id}')"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }

        function updateUI() {
            const planInfo = document.getElementById('planInfo'); const btn = document.getElementById('btnCreate');
            const stEl = document.getElementById('storageQuota'); const daEl = document.getElementById('dailyQuota');
            let isVip = userProfile.isPremium && userProfile.expiryDate && userProfile.expiryDate.toDate() > new Date();

            if(isVip) {
                const days = Math.ceil((userProfile.expiryDate.toDate() - new Date())/86400000);
                planInfo.innerHTML = `<span class="badge bg-warning text-dark"><i class="fa-solid fa-crown"></i> VIP Member (${days} ngày)</span>`;
                stEl.innerText = "Không giới hạn"; daEl.innerText = "Không giới hạn"; btn.disabled = false;
            } else {
                planInfo.innerHTML = `<span class="badge bg-secondary">Tài khoản Miễn phí</span>`;
                stEl.innerHTML = `<span class="${myStorageCount>=LIMITS.STORAGE?'text-danger':'text-success'}">${myStorageCount}/${LIMITS.STORAGE}</span>`;
                daEl.innerHTML = `<span class="${myDailyUsage>=LIMITS.DAILY?'text-danger':'text-success'}">${myDailyUsage}/${LIMITS.DAILY}</span>`;
                
                if(myStorageCount >= LIMITS.STORAGE || myDailyUsage >= LIMITS.DAILY) {
                    btn.disabled = true; btn.innerHTML = "<i class='fa-solid fa-lock'></i> Đạt giới hạn";
                } else {
                    btn.disabled = false; btn.innerHTML = "<i class='fa-solid fa-magic me-2'></i>TẠO MÃ QR NGAY";
                }
            }
        }

        document.getElementById('createQrForm').addEventListener('submit', async (e) => {
            e.preventDefault(); const btn = document.getElementById('btnCreate'); btn.disabled = true;
            try {
                const name = document.getElementById('qrName').value; const dest = document.getElementById('qrDest').value;
                const shortId = Math.random().toString(36).substring(2, 8);
                const link = `${window.location.href.split('?')[0]}?id=${shortId}`;
                const qr = new QRious({ value: link, size: 250 });
                await addDoc(collection(db, "qr_codes_v2"), { uid: currentUser.uid, shortId, name, destination: dest, imageUrl: qr.toDataURL(), views: 0, createdAt: serverTimestamp() });
                if(!userProfile.isPremium) await updateDoc(doc(db,"users",currentUser.uid), { dailyCount: increment(1), lastActionDate: new Date().toISOString().split('T')[0] });
                document.getElementById('createQrForm').reset(); Swal.fire('Thành công','','success'); await loadData(); switchTab('list');
            } catch (err) { Swal.fire('Lỗi', err.message, 'error'); btn.disabled = false; }
        });

        window.openPaymentModal = () => {
            const content = `TAQR ${currentUser.uid}`;
            const url = `https://img.vietqr.io/image/${BANK_BIN}-${BANK_ACC}-compact.png?amount=50000&addInfo=${encodeURIComponent(content)}`;
            Swal.fire({ title: 'Nâng cấp VIP', html: `<img src="${url}" style="width:200px;border-radius:8px"><div class="mt-2 alert alert-info small text-start">Nội dung chuyển khoản: <b class="text-danger">${content}</b></div>`, confirmButtonText: 'Đã chuyển' });
        };
        window.viewQR = (url) => Swal.fire({ imageUrl: url, showConfirmButton: false, showCloseButton: true });
        window.delQr = async (id) => { if(confirm("Xóa mã này?")) { await deleteDoc(doc(db,"qr_codes_v2",id)); await loadData(); } };
        window.logout = () => signOut(auth);
    }
</script>
</body>
</html>
