<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Login - TA QR Biz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { background-color: #2c3e50; font-family: 'Segoe UI', sans-serif; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .admin-card { width: 100%; max-width: 500px; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .hidden { display: none !important; }
        .panel-header { background: #c0392b; color: white; padding: 15px; border-radius: 10px 10px 0 0; margin: -40px -40px 30px -40px; text-align: center; }
    </style>
</head>
<body>

<div class="admin-card">
    
    <div class="panel-header">
        <h3 class="fw-bold m-0"><i class="fa-solid fa-user-shield me-2"></i>QUẢN TRỊ HỆ THỐNG</h3>
        <small>TA QR Biz Administrator</small>
    </div>

    <div id="login-section">
        <form id="loginForm">
            <div class="mb-3">
                <label class="form-label fw-bold">Email Quản Trị</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fa-solid fa-envelope"></i></span>
                    <input type="email" id="email" class="form-control" placeholder="admin@gmail.com" required>
                </div>
            </div>
            <div class="mb-4">
                <label class="form-label fw-bold">Mật khẩu</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fa-solid fa-key"></i></span>
                    <input type="password" id="password" class="form-control" placeholder="••••••••" required>
                </div>
            </div>
            <button type="submit" class="btn btn-danger w-100 fw-bold py-2">
                ĐĂNG NHẬP <i class="fa-solid fa-arrow-right ms-2"></i>
            </button>
        </form>
        <div id="loginError" class="alert alert-danger mt-3 hidden small"></div>
    </div>

    <div id="tools-section" class="hidden">
        <div class="alert alert-success d-flex justify-content-between align-items-center">
            <span><i class="fa-solid fa-user-check me-2"></i>Xin chào, Admin!</span>
            <button class="btn btn-sm btn-outline-success" onclick="logout()">Thoát</button>
        </div>

        <div class="mb-3">
            <label class="fw-bold mb-2 text-primary">Dán tin nhắn ngân hàng vào đây:</label>
            <textarea id="smsInput" class="form-control" rows="4" placeholder="VD: TK 1234... +50,000... ND: TAQR UserXYZ..."></textarea>
            <div class="form-text text-muted">Hệ thống sẽ tự lọc mã User (TAQR ...)</div>
        </div>
        
        <button class="btn btn-primary w-100 mb-3 py-2 fw-bold shadow-sm" onclick="checkTransaction()">
            <i class="fa-solid fa-magnifying-glass me-2"></i>KIỂM TRA & DUYỆT
        </button>

        <div id="resultBox" class="border rounded p-3 bg-light hidden mt-3">
            </div>
    </div>

    <div id="loading" class="text-center hidden py-4">
        <div class="spinner-border text-danger" role="status"></div>
        <p class="mt-2 text-muted">Đang xác thực...</p>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- CẤU HÌNH ---
    const firebaseConfig = { 
        apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", 
        authDomain: "tavietnam-78ae8.firebaseapp.com", 
        projectId: "tavietnam-78ae8", 
        storageBucket: "tavietnam-78ae8.firebasestorage.app", 
        messagingSenderId: "670121705534", 
        appId: "1:670121705534:web:1027ad98550573ad37116f" 
    };
    
    // !!! QUAN TRỌNG: DÁN UID CỦA BẠN VÀO ĐÂY !!!
    // (Lấy trong Firebase Console -> Authentication -> Cột User UID)
    const ADMIN_UID = "DÁN_MÃ_UID_CỦA_BẠN_VÀO_ĐÂY"; 

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const loginSection = document.getElementById('login-section');
    const toolsSection = document.getElementById('tools-section');
    const loading = document.getElementById('loading');
    const loginError = document.getElementById('loginError');

    // Theo dõi trạng thái đăng nhập
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // Đã đăng nhập -> Kiểm tra xem có phải Admin không?
            loading.classList.remove('hidden');
            loginSection.classList.add('hidden');

            if (user.uid === ADMIN_UID) {
                // ĐÚNG LÀ ADMIN
                loading.classList.add('hidden');
                toolsSection.classList.remove('hidden');
            } else {
                // SAI USER -> ĐUỔI RA
                Swal.fire({
                    icon: 'error',
                    title: 'Truy cập bị từ chối!',
                    text: 'Tài khoản này không có quyền Quản trị.',
                    confirmButtonText: 'Đã hiểu'
                }).then(() => {
                    signOut(auth);
                });
            }
        } else {
            // Chưa đăng nhập
            loading.classList.add('hidden');
            toolsSection.classList.add('hidden');
            loginSection.classList.remove('hidden');
        }
    });

    // Xử lý nút Đăng nhập
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        
        loginError.classList.add('hidden');
        loading.classList.remove('hidden');
        loginSection.classList.add('hidden');

        try {
            await signInWithEmailAndPassword(auth, email, pass);
            // Sau khi signin thành công, onAuthStateChanged ở trên sẽ chạy để check UID
        } catch (error) {
            loading.classList.add('hidden');
            loginSection.classList.remove('hidden');
            loginError.textContent = "Lỗi: Email hoặc mật khẩu không đúng.";
            loginError.classList.remove('hidden');
        }
    });

    // Xử lý Kiểm tra Giao dịch (Logic giữ nguyên từ Ver 2.9)
    window.checkTransaction = async () => {
        const sms = document.getElementById('smsInput').value;
        const resultBox = document.getElementById('resultBox');
        
        const match = sms.match(/TAQR\s*([a-zA-Z0-9]+)/i);

        if(match && match[1]) {
            const targetUid = match[1].trim();
            resultBox.classList.remove('hidden');
            resultBox.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Đang tra cứu...';

            try {
                const userRef = doc(db, "users", targetUid);
                const snap = await getDoc(userRef);

                if(snap.exists()) {
                    const data = snap.data();
                    const expiry = data.expiryDate ? new Date(data.expiryDate.toDate()).toLocaleDateString() : 'Chưa có';
                    
                    resultBox.innerHTML = `
                        <div class="alert alert-info border-info">
                            <strong>Khách hàng:</strong> ${data.email}<br>
                            <strong>Hạn VIP cũ:</strong> ${expiry}
                        </div>
                        <button class="btn btn-success w-100 fw-bold py-2" onclick="confirmUpgrade('${targetUid}')">
                            <i class="fa-solid fa-check-circle me-1"></i> XÁC NHẬN CỘNG 30 NGÀY
                        </button>
                    `;
                } else {
                    resultBox.innerHTML = '<div class="text-danger fw-bold"><i class="fa-solid fa-circle-xmark"></i> Không tìm thấy User này.</div>';
                }
            } catch (e) {
                resultBox.innerHTML = `<div class="text-danger">Lỗi: ${e.message}</div>`;
            }
        } else {
            Swal.fire('Sai cú pháp', 'Tin nhắn không chứa mã "TAQR...". Vui lòng kiểm tra lại.', 'warning');
        }
    };

    // Xác nhận nâng cấp
    window.confirmUpgrade = async (uid) => {
        try {
            const userRef = doc(db, "users", uid);
            const snap = await getDoc(userRef);
            const data = snap.data();
            
            let newDate = new Date();
            // Nếu còn hạn thì cộng dồn
            if(data.isPremium && data.expiryDate && data.expiryDate.toDate() > new Date()) {
                newDate = data.expiryDate.toDate();
            }
            newDate.setDate(newDate.getDate() + 30);

            await updateDoc(userRef, {
                isPremium: true,
                expiryDate: newDate,
                lastPaymentDate: serverTimestamp()
            });

            Swal.fire('Thành công!', `Đã gia hạn VIP đến ngày ${newDate.toLocaleDateString()}`, 'success');
            document.getElementById('smsInput').value = '';
            document.getElementById('resultBox').classList.add('hidden');
        } catch (e) {
            Swal.fire('Lỗi', 'Không thể cập nhật (Kiểm tra lại Rules): ' + e.message, 'error');
        }
    };

    window.logout = () => signOut(auth);
</script>

</body>
</html>
